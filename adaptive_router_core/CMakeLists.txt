cmake_minimum_required(VERSION 3.24)
project(adaptive_router_core VERSION 0.1.0 LANGUAGES CXX)

# C++ standard - use C++23 for broader compiler support
# C++26 features used are minimal and available in C++23
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Cross-platform visibility settings
set(CMAKE_CXX_VISIBILITY_PRESET hidden)
set(CMAKE_VISIBILITY_INLINES_HIDDEN ON)

# Conan toolchain (generated by conan install)
if(EXISTS "${CMAKE_BINARY_DIR}/conan_toolchain.cmake")
  include("${CMAKE_BINARY_DIR}/conan_toolchain.cmake")
endif()

# Find dependencies (no ONNX - embeddings computed externally)
find_package(Eigen3 REQUIRED)
find_package(nlohmann_json REQUIRED)
find_package(msgpack-cxx REQUIRED)

# Core library
add_library(adaptive_core STATIC
    src/router.cpp
    src/cluster.cpp
    src/scorer.cpp
    src/profile.cpp
)

target_include_directories(adaptive_core PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

target_link_libraries(adaptive_core PUBLIC
    Eigen3::Eigen
    nlohmann_json::nlohmann_json
    msgpack-cxx
)

target_compile_features(adaptive_core PUBLIC cxx_std_23)

# Python bindings
add_subdirectory(bindings/python)

# C API
add_library(adaptive_c SHARED bindings/c/adaptive_c.cpp)
target_link_libraries(adaptive_c PRIVATE adaptive_core)
target_include_directories(adaptive_c PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/bindings/c>
)
target_compile_features(adaptive_c PRIVATE cxx_std_23)
target_compile_definitions(adaptive_c PRIVATE ADAPTIVE_C_EXPORTS)

# Set proper output name for all platforms
set_target_properties(adaptive_c PROPERTIES
    OUTPUT_NAME "adaptive_c"
    VERSION ${PROJECT_VERSION}
    SOVERSION 0
)

# Windows-specific settings
if(WIN32)
    # No special Windows settings needed - CMake handles DLL export/import
    set_target_properties(adaptive_c PROPERTIES
        WINDOWS_EXPORT_ALL_SYMBOLS OFF  # We use explicit ADAPTIVE_API macros
    )
endif()

# Tests (optional, controlled by BUILD_TESTING)
option(BUILD_TESTING "Build tests" OFF)
if(BUILD_TESTING)
  enable_testing()
  add_subdirectory(tests)
endif()
