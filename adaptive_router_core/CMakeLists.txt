cmake_minimum_required(VERSION 3.24)

# Optional CUDA support - must be set before project()
option(ENABLE_CUDA "Enable CUDA GPU acceleration for cluster assignment" OFF)

if(ENABLE_CUDA)
  project(adaptive_router_core VERSION 0.1.0 LANGUAGES CXX CUDA)
else()
  project(adaptive_router_core VERSION 0.1.0 LANGUAGES CXX)
endif()

# C++ standard - use C++23 for broader compiler support
# C++26 features used are minimal and available in C++23
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Cross-platform visibility settings
set(CMAKE_CXX_VISIBILITY_PRESET hidden)
set(CMAKE_VISIBILITY_INLINES_HIDDEN ON)

# Verify compiler supports C++23
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU")
  if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS 12.0)
    message(FATAL_ERROR "GCC 12+ required for C++23 support (found ${CMAKE_CXX_COMPILER_VERSION})")
  endif()
elseif(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS 15.0)
    message(FATAL_ERROR "Clang 15+ required for C++23 support (found ${CMAKE_CXX_COMPILER_VERSION})")
  endif()
elseif(CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
  if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS 19.30)
    message(FATAL_ERROR "MSVC 19.30+ (VS 2022 17.0+) required for C++23 support (found ${CMAKE_CXX_COMPILER_VERSION})")
  endif()
endif()

# Conan toolchain (generated by conan install)
# Look in multiple locations for the conan toolchain (both Release and Debug)
set(CONAN_TOOLCHAIN_PATHS
    "${CMAKE_BINARY_DIR}/conan_toolchain.cmake"
    "${CMAKE_SOURCE_DIR}/build/build/Release/generators/conan_toolchain.cmake"
    "${CMAKE_CURRENT_SOURCE_DIR}/build/build/Release/generators/conan_toolchain.cmake"
    "${CMAKE_SOURCE_DIR}/build/build/Debug/generators/conan_toolchain.cmake"
    "${CMAKE_CURRENT_SOURCE_DIR}/build/build/Debug/generators/conan_toolchain.cmake"
)

foreach(TOOLCHAIN_PATH ${CONAN_TOOLCHAIN_PATHS})
  if(EXISTS "${TOOLCHAIN_PATH}")
    message(STATUS "Including Conan toolchain from: ${TOOLCHAIN_PATH}")
    include("${TOOLCHAIN_PATH}")
    # Also add the generators directory to CMAKE_PREFIX_PATH
    get_filename_component(GENERATORS_DIR "${TOOLCHAIN_PATH}" DIRECTORY)
    list(APPEND CMAKE_PREFIX_PATH "${GENERATORS_DIR}")
    break()
  endif()
endforeach()

# Find dependencies (no ONNX - embeddings computed externally)
find_package(Eigen3 REQUIRED)
find_package(nlohmann_json REQUIRED)
find_package(msgpack-cxx REQUIRED)

# Core library
add_library(adaptive_core STATIC
    src/router.cpp
    src/cluster_backend.cpp
    src/scorer.cpp
    src/profile.cpp
)

target_include_directories(adaptive_core PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)

target_link_libraries(adaptive_core PUBLIC
    Eigen3::Eigen
    nlohmann_json::nlohmann_json
    msgpack-cxx
)

target_compile_features(adaptive_core PUBLIC cxx_std_23)

# Comprehensive compiler warnings
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
  target_compile_options(adaptive_core PRIVATE
    -Wall -Wextra -Wpedantic -Werror
    -Wconversion -Wsign-conversion
    -Wnon-virtual-dtor -Woverloaded-virtual
    -Wold-style-cast
  )
elseif(MSVC)
  target_compile_options(adaptive_core PRIVATE /W4 /WX)
endif()

# Sanitizer support (off by default)
option(ENABLE_SANITIZERS "Enable address and undefined sanitizers" OFF)
if(ENABLE_SANITIZERS)
  if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_compile_options(adaptive_core PRIVATE
      -fsanitize=address,undefined
      -fno-omit-frame-pointer
    )
    target_link_options(adaptive_core PRIVATE
      -fsanitize=address,undefined
    )
  endif()
endif()

# CUDA GPU acceleration (optional)
if(ENABLE_CUDA)
  message(STATUS "CUDA GPU acceleration enabled")

  # Find CUDA toolkit
  find_package(CUDAToolkit REQUIRED)

  # CUDA library for GPU cluster assignment
  add_library(adaptive_core_cuda STATIC
    src/cuda/cluster_cuda.cu
  )

  target_include_directories(adaptive_core_cuda PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  )

  target_link_libraries(adaptive_core_cuda PRIVATE
    CUDA::cublas
    CUDA::cudart
    Eigen3::Eigen
  )

  # Set CUDA standard to C++17 (CUDA doesn't support C++23 yet)
  set_target_properties(adaptive_core_cuda PROPERTIES
    CUDA_STANDARD 17
    CUDA_STANDARD_REQUIRED ON
    CUDA_SEPARABLE_COMPILATION ON
  )

  # Link CUDA library to core
  target_link_libraries(adaptive_core PRIVATE adaptive_core_cuda)
  target_compile_definitions(adaptive_core PUBLIC ADAPTIVE_HAS_CUDA=1)
else()
  message(STATUS "CUDA GPU acceleration disabled (use -DENABLE_CUDA=ON to enable)")
endif()

# Python bindings
add_subdirectory(bindings/python)

# C API
add_library(adaptive_c SHARED bindings/c/adaptive_c.cpp)
target_link_libraries(adaptive_c PRIVATE adaptive_core)
target_include_directories(adaptive_c PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/bindings/c>
)
target_compile_features(adaptive_c PRIVATE cxx_std_23)
target_compile_definitions(adaptive_c PRIVATE ADAPTIVE_C_EXPORTS)

# Set proper output name for all platforms
set_target_properties(adaptive_c PROPERTIES
    OUTPUT_NAME "adaptive_c"
    VERSION ${PROJECT_VERSION}
    SOVERSION 0
)

# Windows-specific settings
if(WIN32)
    # No special Windows settings needed - CMake handles DLL export/import
    set_target_properties(adaptive_c PROPERTIES
        WINDOWS_EXPORT_ALL_SYMBOLS OFF  # We use explicit ADAPTIVE_API macros
    )
endif()

# Clang-format target (run manually with: cmake --build <dir> --target format)
find_program(CLANG_FORMAT NAMES clang-format-18 clang-format)
if(CLANG_FORMAT)
  file(GLOB_RECURSE ALL_SOURCE_FILES
    ${CMAKE_SOURCE_DIR}/src/*.cpp
    ${CMAKE_SOURCE_DIR}/include/*.hpp
    ${CMAKE_SOURCE_DIR}/tests/*.cpp
    ${CMAKE_SOURCE_DIR}/bindings/**/*.cpp
    ${CMAKE_SOURCE_DIR}/bindings/**/*.h
  )
  add_custom_target(format
    COMMAND ${CLANG_FORMAT} -i ${ALL_SOURCE_FILES}
    COMMENT "Running clang-format on all source files"
    VERBATIM
  )
endif()

# Tests (optional, controlled by BUILD_TESTING)
option(BUILD_TESTING "Build tests" OFF)
if(BUILD_TESTING)
  enable_testing()
  add_subdirectory(tests)
endif()
